<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FancyTree avec Firebase et Importation XLS</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/jquery.fancytree@2.37.0/dist/skin-lion/ui.fancytree.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery.fancytree@2.37.0/dist/jquery.fancytree-all-deps.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js"></script>

    <style>
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { border: 1px solid #ddd; padding: 8px; }
    </style>
</head>
<body>
    <h2>FancyTree avec Importation XLS et Firebase</h2>
    <input type="file" id="importExcel" accept=".xlsx">
    <table id="fancytreeTable" class="table">
        <thead>
            <tr>
                <th>Key</th>
                <th>Title</th>
                <th>Colonne 1</th>
                <th>Colonne 2</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        // Configuration Firebase avec des valeurs correctes
        const firebaseConfig = {
             apiKey: "AIzaSyBFEt617ywvSB1dqoca95idSEMILMNHo3Q",

  authDomain: "pacautov2.firebaseapp.com",

  databaseURL: "https://pacautov2-default-rtdb.europe-west1.firebasedatabase.app",

  projectId: "pacautov2",

  storageBucket: "pacautov2.appspot.com",

  messagingSenderId: "307082937084",

  appId: "1:307082937084:web:06ab27ea5da0ac0e454d79"

        };

        // Initialisation de Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Fonction pour sauvegarder les données dans Firebase après l'importation FancyTree
        function saveToFirebase(treeData) {
            treeData.forEach(node => {
                const nodeId = node.key;
                firebase.database().ref('tree/' + nodeId).set(node)
                    .then(() => console.log(`Données sauvegardées pour le nœud ${nodeId}`))
                    .catch(err => console.error(`Erreur de sauvegarde : ${err}`));
            });
        }

        // Gestion de l'importation du fichier Excel
        document.getElementById('importExcel').addEventListener('change', function(event) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                generateFancyTreeFromExcel(sheet); // Charger d'abord dans FancyTree
            };
            reader.readAsArrayBuffer(event.target.files[0]);
        });

        // Fonction pour générer FancyTree à partir des données Excel
        function generateFancyTreeFromExcel(data) {
            let treeData = [];

            data.forEach((row, index) => {
                if (index === 0) return; // Ignorer l'en-tête

                let newNode = {
                    key: index,  // Clé unique basée sur l'index
                    title: row[1] || "Titre manquant",  // Colonne 2 du fichier Excel
                    folder: false,
                    data: {
                        column1: row[0] || "N/A",  // Colonne 1
                        column3: row[2] || "N/A"   // Colonne 3
                    }
                };
                treeData.push(newNode);
            });

            // Création de FancyTree avec les données importées
            $("#fancytreeTable").fancytree({
                extensions: ["table"],
                table: {
                    checkboxColumnIdx: 0,  // Ajouter des cases à cocher dans cette colonne
                    indentation: 20,       // Indentation pour la structure de l'arbre
                    nodeColumnIdx: 1       // Placer l'expandeur et le titre du nœud dans cette colonne
                },
                source: treeData,
                renderColumns: function(event, data) {
                    var node = data.node,
                        $tdList = $(node.tr).find(">td");

                    $tdList.eq(0).text(node.key);  // Afficher la clé du nœud
                    $tdList.eq(1).text(node.title);  // Afficher le titre du nœud
                    $tdList.eq(2).text(node.data.column1);  // Afficher les données personnalisées pour la colonne 1
                    $tdList.eq(3).text(node.data.column3);  // Afficher les données personnalisées pour la colonne 3
                }
            });

            // Sauvegarder les données dans Firebase après que FancyTree est généré
            saveToFirebase(treeData);
        }
    </script>
</body>
</html>





