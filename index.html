<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importation XLS et FancyTree avec 14 colonnes et Drag and Drop</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.fancytree/2.38.0/skin-lion/ui.fancytree.min.css">
    <style>
        body {
            display: flex;
        }
        .left-pane {
            width: 50%;
            padding: 10px;
            height: 100vh; /* Hauteur de la fenêtre */
            overflow-y: auto; /* Défilement vertical indépendant */
        }
        .right-pane {
            width: 50%;
            padding: 10px;
            height: 100vh; /* Hauteur de la fenêtre */
            overflow-y: auto; /* Défilement vertical indépendant */
        }
        #tree {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
        }
        .draggable {
            cursor: move;
        }
        .highlight {
            background-color: green !important;
        }
        .counter-green {
            background-color: green !important;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        // Importer les fonctions Firebase spécifiques
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            databaseURL: "YOUR_FIREBASE_DATABASE_URL",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
            appId: "YOUR_FIREBASE_APP_ID"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let counters = {};  // Objet pour stocker les compteurs de chaque élément

        // Fonction pour mettre à jour le compteur affiché
        function updateCounterDisplay(rowElement, counter) {
            const counterCell = rowElement.querySelector('td:last-child');
            counterCell.textContent = counter;
            if (counter > 0) {
                counterCell.classList.add('counter-green');
            } else {
                counterCell.classList.remove('counter-green');
            }
        }

        // Fonction pour gérer le clic sur la cellule du compteur
        function toggleElementHighlight(row) {
            const title = row.querySelector('td:nth-child(2)').textContent;
            const element = document.querySelector(`.right-pane [data-title='${title}']`);
            if (element) {
                if (element.classList.contains('highlight')) {
                    element.classList.remove('highlight');
                } else {
                    element.classList.add('highlight');
                }
            }
        }

        // Sauvegarde des données dans Firebase
        function saveDataToFirebase(treeData, path) {
            set(ref(db, path), treeData)
              .then(() => {
                console.log('Données sauvegardées dans Firebase avec succès');
              })
              .catch((error) => {
                console.error('Erreur lors de la sauvegarde dans Firebase:', error);
              });
        }

        // Chargement des données depuis Firebase
        function loadDataFromFirebase(path, callback) {
            const dbRef = ref(db, path);
            get(dbRef)
              .then((snapshot) => {
                if (snapshot.exists()) {
                    callback(snapshot.val());
                } else {
                    console.log("Aucune donnée trouvée dans Firebase");
                }
              })
              .catch((error) => {
                console.error("Erreur lors de la lecture des données :", error);
              });
        }

        // Fonction pour incrémenter le compteur d'un élément donné
        function incrementCounterForTitle(title) {
            const rows = document.querySelectorAll("#tree tbody tr");
            rows.forEach(function(row) {
                const rowTitle = row.querySelector('td:nth-child(2)').textContent;
                if (rowTitle === title) {
                    let counter = parseInt(row.querySelector('td:last-child').textContent) || 0;
                    counter++;
                    counters[title] = counter;
                    updateCounterDisplay(row, counter);
                }
            });
        }

        // Fonction pour décrémenter le compteur d'un élément donné
        function decrementCounterForTitle(title) {
            const rows = document.querySelectorAll("#tree tbody tr");
            rows.forEach(function(row) {
                const rowTitle = row.querySelector('td:nth-child(2)').textContent;
                if (rowTitle === title) {
                    let counter = parseInt(row.querySelector('td:last-child').textContent) || 0;
                    if (counter > 0) {
                        counter--;
                    }
                    counters[title] = counter;
                    updateCounterDisplay(row, counter);
                }
            });
        }

        // Lecture du fichier Excel
        document.getElementById('importExcel').addEventListener('change', function(event) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, { type: 'array' });
                var sheetName = workbook.SheetNames[0];
                var sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                importExcelData(sheet);
            };
            reader.readAsArrayBuffer(event.target.files[0]);
        });

        // Fonction pour charger et afficher les données de FancyTree depuis Firebase au démarrage
        window.addEventListener('load', function() {
            loadDataFromFirebase('fancytree/leftPane', function(data) {
                $("#tree").fancytree("getTree").reload(data);
            });

            loadDataFromFirebase('fancytree/rightPane', function(data) {
                $("#tree-right").fancytree("getTree").reload(data);
            });
        });

        // Configuration de FancyTree pour la fenêtre de gauche
        $("#tree").fancytree({
            extensions: ["table"],
            checkbox: false,
            source: [],
            table: {
                indentation: 20,
                nodeColumnIdx: 1 // Colonne pour le titre du nœud
            },
            renderColumns: function(event, data) {
                var node = data.node;
                var $tdList = $(node.tr).find(">td");

                // Affichage des colonnes avec les données extraites
                $tdList.eq(0).text(node.key);  // Clé du nœud
                $tdList.eq(1).text(node.title);  // Titre du nœud (colonne 3)
                $tdList.eq(1).attr("title", node.tooltip);  // Ajouter tooltip à la colonne 3
                $tdList.eq(2).text(node.data.column1);  // Colonne 1
                $tdList.eq(3).text(node.data.column2);  // Colonne 2
                $tdList.eq(4).text(node.data.column6);  // Colonne 6
                $tdList.eq(5).text(node.data.column8);  // Colonne 8
                $tdList.eq(6).text(node.data.column9);  // Colonne 9
                $tdList.eq(7).text(node.data.column11);  // Colonne 11
                $tdList.eq(8).text(node.data.column12);  // Colonne 12
                $tdList.eq(9).text(node.data.column13);  // Colonne 13
                $tdList.eq(10).text(node.data.column14);  // Colonne 14
                $tdList.eq(11).text(node.data.column15);  // Colonne 15
                $tdList.eq(12).text(node.data.column16);  // Colonne 16
                $tdList.eq(13).text(node.data.column17);  // Colonne 17
                $tdList.eq(14).text(counters[node.title] || 0);  // Compteur

                // Ajout de l'événement clic sur la cellule du compteur
                $tdList.eq(14).on('click', function() {
                    toggleElementHighlight(node.tr);
                });
            }
        });

        // Configuration de FancyTree pour la fenêtre de droite
        $("#tree-right").fancytree({
            extensions: ["dnd5"],
            source: [],
            dnd5: {
                preventRecursion: true,
                preventVoidMoves: true,
                dragStart: function(node, data) {
                    return true;
                },
                dragEnter: function(node, data) {
                    if (!data.otherNode) {
                        return node.folder ? ["over"] : false;
                    }
                    if (data.otherNode.folder) {
                        return node.folder ? ["before", "after", "over"] : false;
                    } else {
                        return node.folder ? ["over"] : ["before", "after"];
                    }
                },
                dragDrop: function(node, data) {
                    var title, tooltip;

                    if (data.otherNode) {
                        // Si un élément est déplacé ou copié depuis le plan
                        title = data.otherNode.title;
                        tooltip = data.otherNode.tooltip;

                        var newNode = {
                            title: title,
                            tooltip: tooltip,
                            folder: false,
                            allowChildren: false
                        };

                        if (!data.otherNode.folder && node.folder) {
                            var children = node.getChildren();
                            if (children && children.length > 0) {
                                var firstFolderChild = children.find(child => child.folder);
                                if (firstFolderChild) {
                                    // Déplacer ou copier avant le premier répertoire
                                    data.otherNode.moveTo(firstFolderChild, "before");
                                } else {
                                    // Si aucun sous-répertoire n'est trouvé, ajouter comme enfant normal
                                    data.otherNode.moveTo(node, "child");
                                }
                            } else {
                                data.otherNode.moveTo(node, "child");
                            }
                        } else {
                            data.otherNode.moveTo(node, data.hitMode);
                        }

                    } else {
                        // Si un élément est déposé depuis l'extérieur (comme depuis la partie gauche)
                        title = data.dataTransfer.getData("text/plain");
                        tooltip = data.dataTransfer.getData("text/tooltip");

                        var newNode = {
                            title: title,
                            tooltip: tooltip,
                            folder: false,
                            allowChildren: false
                        };

                        if (node.folder) {
                            var children = node.getChildren();
                            if (children && children.length > 0) {
                                var firstFolderChild = children.find(child => child.folder);
                                if (firstFolderChild) {
                                    // Insérer avant le premier sous-répertoire trouvé
                                    node.addChildren(newNode, firstFolderChild);
                                } else {
                                    node.addChildren(newNode);
                                }
                            } else {
                                node.addChildren(newNode);
                            }
                        } else {
                            node.addChildren(newNode, data.hitMode);
                        }
                        node.setExpanded(true);

                        incrementCounterForTitle(title);
                    }

                    // Sauvegarder les modifications dans Firebase après chaque drag and drop
                    const treeLeft = $("#tree").fancytree("getTree").toDict(true);
                    saveDataToFirebase(treeLeft, 'fancytree/leftPane');

                    const treeRight = $("#tree-right").fancytree("getTree").toDict(true);
                    saveDataToFirebase(treeRight, 'fancytree/rightPane');
                }
            }
        });

        // Gestion du plan DOCX, JSON, et HTML
        document.getElementById('importWord').addEventListener('change', function(event) {
            const reader = new FileReader();
            reader.onload = function(e) {
                mammoth.convertToHtml({ arrayBuffer: e.target.result })
                    .then(result => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(result.value, 'text/html');
                        buildFancyTreeFromDocx(doc.body);
                    });
            };
            reader.readAsArrayBuffer(event.target.files[0]);
        });

        function buildFancyTreeFromDocx(content) {
            const treeData = [];
            const stack = [treeData];
content.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(heading => {
                const level = parseInt(heading.tagName[1]);
                const node = { title: heading.textContent, folder: true, children: [] };
                while (stack.length > level) stack.pop();
                stack[stack.length - 1].push(node);
                stack.push(node.children);
            });
            $("#tree-right").fancytree("getTree").reload(treeData);

            // Sauvegarder les données du plan DOCX dans Firebase après l'importation
            saveDataToFirebase(treeData, 'fancytree/rightPane');
        }

        document.getElementById('exportJsonBtn').addEventListener('click', function() {
            const tree = $("#tree-right").fancytree("getTree").toDict(true);
            const json = JSON.stringify(tree, null, 2);
            const blob = new Blob([json], { type: "application/json" });
            saveAs(blob, "plan.json");
        });

        document.getElementById('importJsonBtn').addEventListener('click', function() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'application/json';
            fileInput.addEventListener('change', function(event) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const json = JSON.parse(e.target.result);
                    $("#tree-right").fancytree("getTree").reload(json);

                    // Sauvegarder les données importées dans Firebase
                    saveDataToFirebase(json, 'fancytree/rightPane');
                };
                reader.readAsText(event.target.files[0]);
            });
            fileInput.click();
        });

        document.getElementById('exportHtmlBtn').addEventListener('click', function() {
            const tree = $("#tree-right").fancytree("getTree").toDict(true);

            function traverseTree(node, depth = 1) {
                let output = '';
                const title = node.title || '';
                const tooltip = node.tooltip || '';
                if (node.folder) {
                    output += `<h${depth}>${title}</h${depth}><p>${tooltip}</p>`;
                } else {
                    output += `<p><strong>${title}</strong><br>${tooltip}</p>`;
                }
                if (node.children) {
                    node.children.forEach(child => {
                        output += traverseTree(child, depth + 1);
                    });
                }
                return output;
            }

            const htmlContent = `
            <!DOCTYPE html>
            <html lang="fr">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Plan Hiérarchique Exporté</title>
            </head>
            <body>
                ${traverseTree(tree)}
            </body>
            </html>`;

            const blob = new Blob([htmlContent], { type: "text/html" });
            saveAs(blob, "plan_hierarchique.html");
        });

        // Gestion des boutons "Ajouter Sous-répertoire" et "Supprimer répertoire"
        document.getElementById('addNodeBtn').addEventListener('click', function() {
            const tree = $("#tree-right").fancytree("getTree");
            const activeNode = tree.getActiveNode();
            if (activeNode) {
                const nodeName = prompt("Entrez le nom du nouveau sous-répertoire:");
                if (nodeName) {
                    activeNode.addChildren({ title: nodeName, folder: true });
                    activeNode.setExpanded(true);

                    // Sauvegarder les modifications après ajout de répertoire
                    const treeRight = tree.toDict(true);
                    saveDataToFirebase(treeRight, 'fancytree/rightPane');
                }
            } else {
                alert("Veuillez sélectionner un répertoire pour ajouter un sous-répertoire.");
            }
        });

        document.getElementById('deleteNodeBtn').addEventListener('click', function() {
            const tree = $("#tree-right").fancytree("getTree");
            const activeNode = tree.getActiveNode();
            if (activeNode && confirm("Êtes-vous sûr de vouloir supprimer ce répertoire et tous ses sous-répertoires?")) {
                function decrementCountersForDeletedNode(node) {
                    if (!node.folder) {
                        decrementCounterForTitle(node.title);
                    }
                    const children = node.getChildren();
                    if (children) {
                        children.forEach(child => decrementCountersForDeletedNode(child));
                    }
                }

                decrementCountersForDeletedNode(activeNode);
                activeNode.remove();

                // Sauvegarder les modifications après suppression de répertoire
                const treeRight = tree.toDict(true);
                saveDataToFirebase(treeRight, 'fancytree/rightPane');
            } else {
                alert("Veuillez sélectionner un répertoire à supprimer.");
            }
        });
    </script>

</body>
</html>







